<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>Appendix&nbsp;D.&nbsp;HFile format version 2</title><link rel="stylesheet" type="text/css" href="../css/freebsd_docbook.css"><meta name="generator" content="DocBook XSL-NS Stylesheets V1.76.1"><link rel="home" href="book.html" title=""><link rel="up" href="book.html" title=""><link rel="prev" href="apc.html" title="Appendix&nbsp;C.&nbsp;YCSB: The Yahoo! Cloud Serving Benchmark and HBase"><link rel="next" href="apds02.html" title="D.2.&nbsp;HFile format version 1 overview"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">Appendix&nbsp;D.&nbsp;HFile format version 2</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="apc.html">Prev</a>&nbsp;</td><th width="60%" align="center">&nbsp;</th><td width="20%" align="right">&nbsp;<a accesskey="n" href="apds02.html">Next</a></td></tr></table><hr></div><div class="appendix" title="Appendix&nbsp;D.&nbsp;HFile format version 2"><div class="titlepage"><div><div><h2 class="title"><a name="hfilev2"></a>Appendix&nbsp;D.&nbsp;HFile format version 2</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="hfilev2.html#d1223e7717">D.1. Motivation </a></span></dt><dt><span class="section"><a href="apds02.html">D.2. HFile format version 1 overview </a></span></dt><dd><dl><dt><span class="section"><a href="apds02.html#d1223e7750">D.2.1.  Block index format in version 1 </a></span></dt></dl></dd><dt><span class="section"><a href="apds03.html">D.3. 
      HBase file format with inline blocks (version 2)
      </a></span></dt><dd><dl><dt><span class="section"><a href="apds03.html#d1223e7777">D.3.1.  Overview</a></span></dt><dt><span class="section"><a href="apds03.html#d1223e7792">D.3.2. Unified version 2 block format</a></span></dt><dt><span class="section"><a href="apds03.html#d1223e7861">D.3.3.  Block index in version 2</a></span></dt><dt><span class="section"><a href="apds03.html#d1223e7886">D.3.4. 
      Root block index format in version 2</a></span></dt><dt><span class="section"><a href="apds03.html#d1223e7939">D.3.5. 
      Non-root block index format in version 2</a></span></dt><dt><span class="section"><a href="apds03.html#d1223e7964">D.3.6. 
      Bloom filters in version 2</a></span></dt><dt><span class="section"><a href="apds03.html#d1223e8001">D.3.7. File Info format in versions 1 and 2</a></span></dt><dt><span class="section"><a href="apds03.html#d1223e8047">D.3.8. 
      Fixed file trailer format differences between versions 1 and 2</a></span></dt></dl></dd></dl></div><div class="section" title="D.1.&nbsp;Motivation"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d1223e7717"></a>D.1.&nbsp;Motivation </h2></div></div></div><p>We found it necessary to revise the HFile format after encountering high memory usage and slow startup times caused by large Bloom filters and block indexes in the region server. Bloom filters can get as large as 100 MB per HFile, which adds up to 2 GB when aggregated over 20 regions. Block indexes can grow as large as 6 GB in aggregate size over the same set of regions. A region is not considered opened until all of its block index data is loaded. Large Bloom filters produce a different performance problem: the first get request that requires a Bloom filter lookup will incur the latency of loading the entire Bloom filter bit array.</p><p>To speed up region server startup we break Bloom filters and block indexes into multiple blocks and write those blocks out as they fill up, which also reduces the HFile writer&#8217;s memory footprint. In the Bloom filter case, &#8220;filling up a block&#8221; means accumulating enough keys to efficiently utilize a fixed-size bit array, and in the block index case we accumulate an &#8220;index block&#8221; of the desired size. Bloom filter blocks and index blocks (we call these &#8220;inline blocks&#8221;) become interspersed with data blocks, and as a side effect we can no longer rely on the difference between block offsets to determine data block length, as it was done in version 1.</p><p>HFile is a low-level file format by design, and it should not deal with application-specific details such as Bloom filters, which are handled at StoreFile level. Therefore, we call Bloom filter blocks in an HFile "inline" blocks. We also supply HFile with an interface to write those inline blocks. </p><p>Another format modification aimed at reducing the region server startup time is to use a contiguous &#8220;load-on-open&#8221; section that has to be loaded in memory at the time an HFile is being opened. Currently, as an HFile opens, there are separate seek operations to read the trailer, data/meta indexes, and file info. To read the Bloom filter, there are two more seek operations for its &#8220;data&#8221; and &#8220;meta&#8221; portions. In version 2, we seek once to read the trailer and seek again to read everything else we need to open the file from a contiguous block.</p></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="apc.html">Prev</a>&nbsp;</td><td width="20%" align="center">&nbsp;</td><td width="40%" align="right">&nbsp;<a accesskey="n" href="apds02.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">Appendix&nbsp;C.&nbsp;YCSB: The Yahoo! Cloud Serving Benchmark and HBase&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="book.html">Home</a></td><td width="40%" align="right" valign="top">&nbsp;D.2.&nbsp;HFile format version 1 overview </td></tr></table></div></body></html>